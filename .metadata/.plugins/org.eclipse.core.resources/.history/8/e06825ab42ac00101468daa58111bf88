<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
    <%@ taglib uri="jakarta.tags.core" prefix="c" %>
        <%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
            <!DOCTYPE html>
            <html>

            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Quản lý người dùng - ABC News</title>
                <link rel="stylesheet" href="${pageContext.request.contextPath}/assets/css/style.css">
                <link rel="stylesheet" href="${pageContext.request.contextPath}/assets/css/admin.css">
            </head>

            <body>
                <!-- Header -->
                <header class="admin-header">
                    <div class="container">
                        <div class="header-content">
                            <div class="logo">
                                <h1>ABC News - Quản trị</h1>
                            </div>
                            <div class="user-info">
                                <span>Xin chào, ${sessionScope.user.fullname}</span>
                                <a href="${pageContext.request.contextPath}/" class="btn-home">Trang chủ</a>
                                <a href="${pageContext.request.contextPath}/logout" class="btn-logout">Đăng xuất</a>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Admin Navigation -->
                <nav class="admin-nav">
                    <div class="container">
                        <ul class="admin-menu">
                            <li><a href="${pageContext.request.contextPath}/admin">Trang chủ</a></li>
                            <li><a href="${pageContext.request.contextPath}/admin/news">Quản lý tin tức</a></li>
                            <li><a href="${pageContext.request.contextPath}/admin/categories">Quản lý loại tin</a></li>
                            <li><a href="${pageContext.request.contextPath}/admin/users" class="active">Quản lý người
                                    dùng</a></li>
                            <li><a href="${pageContext.request.contextPath}/admin/newsletters">Quản lý Newsletter</a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="admin-content">
                    <div class="container">
                        <div class="page-header">
                            <h2>Quản lý người dùng</h2>
                            <button type="button" class="btn-primary" onclick="showAddForm()">Thêm người dùng
                                mới</button>
                        </div>

                        <!-- Add/Edit User Form -->
                        <div id="userForm" class="form-container" style="display: none;">
                            <div class="form-header">
                                <h3 id="formTitle">Thêm người dùng mới</h3>
                                <button type="button" class="btn-close" onclick="hideForm()">×</button>
                            </div>
                            <form action="${pageContext.request.contextPath}/admin/users/save" method="post"
                                class="admin-form">
                                <input type="hidden" id="userId" name="id">

                                <div class="form-row">
                                    <div class="form-group half">
                                        <label for="username">Tên đăng nhập *</label>
                                        <input type="text" id="username" name="id" required maxlength="10"
                                            placeholder="Nhập tên đăng nhập...">
                                    </div>

                                    <div class="form-group half">
                                        <label for="fullname">Họ và tên *</label>
                                        <input type="text" id="fullname" name="fullname" required maxlength="40"
                                            placeholder="Nhập họ và tên...">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group half">
                                        <label for="email">Email *</label>
                                        <input type="email" id="email" name="email" required maxlength="30"
                                            placeholder="Nhập email...">
                                    </div>

                                    <div class="form-group half">
                                        <label for="mobile">Số điện thoại</label>
                                        <input type="tel" id="mobile" name="mobile" maxlength="10"
                                            placeholder="Nhập số điện thoại...">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group half">
                                        <label for="password">Mật khẩu *</label>
                                        <input type="password" id="password" name="password" required maxlength="50"
                                            placeholder="Nhập mật khẩu...">
                                    </div>

                                    <div class="form-group half">
                                        <label for="birthday">Ngày sinh</label>
                                        <input type="date" id="birthday" name="birthday">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group half">
                                        <label for="gender">Giới tính</label>
                                        <select id="gender" name="gender">
                                            <option value="">-- Chọn giới tính --</option>
                                            <option value="1">Nam</option>
                                            <option value="0">Nữ</option>
                                        </select>
                                    </div>

                                    <div class="form-group half">
                                        <label for="role">Vai trò *</label>
                                        <select id="role" name="role" required>
                                            <option value="">-- Chọn vai trò --</option>
                                            <option value="1">Quản trị viên</option>
                                            <option value="0">Phóng viên</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn-primary" id="submitBtn">Thêm mới</button>
                                    <button type="button" class="btn-secondary" onclick="hideForm()">Hủy</button>
                                </div>
                            </form>
                        </div>

                        <!-- Search and Filter -->
                        <div class="search-filter">
                            <form action="${pageContext.request.contextPath}/admin/users" method="get"
                                class="search-form">
                                <input type="text" name="search" placeholder="Tìm kiếm người dùng..."
                                    value="${param.search}">
                                <select name="role">
                                    <option value="">Tất cả vai trò</option>
                                    <option value="1" <c:if test="${param.role == '1'}">selected</c:if>>Quản trị viên
                                    </option>
                                    <option value="0" <c:if test="${param.role == '0'}">selected</c:if>>Phóng viên
                                    </option>
                                </select>
                                <button type="submit" class="btn-search">Tìm kiếm</button>
                            </form>
                        </div>

                        <!-- Users Table -->
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tên đăng nhập</th>
                                        <th>Họ và tên</th>
                                        <th>Email</th>
                                        <th>Số điện thoại</th>
                                        <th>Vai trò</th>
                                        <th>Giới tính</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <c:forEach var="user" items="${users}">
                                        <tr>
                                            <td>${user.id}</td>
                                            <td>${user.fullname}</td>
                                            <td>${user.email}</td>
                                            <td>${user.mobile}</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${user.role == 1}">
                                                        <span class="badge badge-success">Quản trị</span>
                                                    </c:when>
                                                    <c:otherwise>
                                                        <span class="badge badge-secondary">Phóng viên</span>
                                                    </c:otherwise>
                                                </c:choose>
                                            </td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${user.gender == 1}">Nam</c:when>
                                                    <c:when test="${user.gender == 0}">Nữ</c:when>
                                                    <c:otherwise>-</c:otherwise>
                                                </c:choose>
                                            </td>
                                            <td class="actions">
                                                <button type="button" class="btn-edit"
                                                    onclick="editUser('${user.id}', '${user.fullname}', '${user.email}', '${user.mobile}', '${user.role}', '${user.gender}', '<fmt:formatDate value="
                                                    ${user.birthday}" pattern="yyyy-MM-dd" />')"
                                                title="Sửa">✏️</button>
                                                <c:if test="${user.id != sessionScope.user.id}">
                                                    <a href="${pageContext.request.contextPath}/admin/users/delete?id=${user.id}"
                                                        class="btn-delete" title="Xóa"
                                                        onclick="return confirmDelete('${user.fullname}')">🗑️</a>
                                                </c:if>
                                            </td>
                                        </tr>
                                    </c:forEach>
                                </tbody>
                            </table>
                        </div>

                        <c:if test="${empty users}">
                            <div class="empty-state">
                                <p>Không tìm thấy người dùng nào.</p>
                            </div>
                        </c:if>

                        <c:if test="${not empty message}">
                            <div class="message ${messageType}">
                                ${message}
                            </div>
                        </c:if>
                    </div>
                </main>

                <!-- Footer -->
                <footer class="admin-footer">
                    <div class="container">
                        <p>&copy; 2024 ABC News Admin Panel. Tất cả quyền được bảo lưu.</p>
                    </div>
                </footer>

                <script>
                    function showAddForm() {
                        document.getElementById('userForm').style.display = 'block';
                        document.getElementById('formTitle').textContent = 'Thêm người dùng mới';
                        document.getElementById('submitBtn').textContent = 'Thêm mới';
                        clearForm();
                        document.getElementById('username').focus();
                    }

                    function editUser(id, fullname, email, mobile, role, gender, birthday) {
                        document.getElementById('userForm').style.display = 'block';
                        document.getElementById('formTitle').textContent = 'Sửa thông tin người dùng';
                        document.getElementById('submitBtn').textContent = 'Cập nhật';

                        document.getElementById('userId').value = id;
                        document.getElementById('username').value = id;
                        document.getElementById('username').readOnly = true;
                        document.getElementById('fullname').value = fullname;
                        document.getElementById('email').value = email;
                        document.getElementById('mobile').value = mobile;
                        document.getElementById('role').value = role;
                        document.getElementById('gender').value = gender;
                        document.getElementById('birthday').value = birthday;
                        document.getElementById('password').required = false;
                        document.getElementById('password').placeholder = 'Để trống nếu không đổi mật khẩu';
                    }

                    function clearForm() {
                        document.getElementById('userId').value = '';
                        document.getElementById('username').value = '';
                        document.getElementById('username').readOnly = false;
                        document.getElementById('fullname').value = '';
                        document.getElementById('email').value = '';
                        document.getElementById('mobile').value = '';
                        document.getElementById('role').value = '';
                        document.getElementById('gender').value = '';
                        document.getElementById('birthday').value = '';
                        document.getElementById('password').required = true;
                        document.getElementById('password').placeholder = 'Nhập mật khẩu...';
                    }

                    function hideForm() {
                        document.getElementById('userForm').style.display = 'none';
                    }

                    function confirmDelete(fullname) {
                        return confirm('Bạn có chắc muốn xóa người dùng "' + fullname + '"?');
                    }

                    // Form validation
                    document.querySelector('.admin-form').addEventListener('submit', function (e) {
                        const username = document.getElementById('username').value.trim();
                        const fullname = document.getElementById('fullname').value.trim();
                        const email = document.getElementById('email').value.trim();
                        const role = document.getElementById('role').value;

                        if (!username || !fullname || !email || !role) {
                            e.preventDefault();
                            alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
                        }
                    });
                </script>
            </body>

            </html>