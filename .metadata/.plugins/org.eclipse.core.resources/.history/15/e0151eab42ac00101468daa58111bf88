<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Newsletter - ABC News</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/assets/css/style.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/assets/css/admin.css">
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>ABC News - Qu·∫£n tr·ªã</h1>
                </div>
                <div class="user-info">
                    <span>Xin ch√†o, ${sessionScope.user.fullname}</span>
                    <a href="${pageContext.request.contextPath}/" class="btn-home">Trang ch·ªß</a>
                    <a href="${pageContext.request.contextPath}/logout" class="btn-logout">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="container">
            <ul class="admin-menu">
                <li><a href="${pageContext.request.contextPath}/admin">Trang ch·ªß</a></li>
                <li><a href="${pageContext.request.contextPath}/admin/news">Qu·∫£n l√Ω tin t·ª©c</a></li>
                <li><a href="${pageContext.request.contextPath}/admin/categories">Qu·∫£n l√Ω lo·∫°i tin</a></li>
                <li><a href="${pageContext.request.contextPath}/admin/users">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a></li>
                <li><a href="${pageContext.request.contextPath}/admin/newsletters" class="active">Qu·∫£n l√Ω Newsletter</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-content">
        <div class="container">
            <div class="page-header">
                <h2>Qu·∫£n l√Ω Newsletter</h2>
                <div class="header-actions">
                    <button type="button" class="btn-info" onclick="exportEmails()">Xu·∫•t danh s√°ch email</button>
                    <button type="button" class="btn-warning" onclick="sendNewsletter()">G·ª≠i newsletter</button>
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-icon">üìß</div>
                    <div class="stat-info">
                        <h3>${totalSubscribers}</h3>
                        <p>T·ªïng ƒëƒÉng k√Ω</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <h3>${activeSubscribers}</h3>
                        <p>ƒêang ho·∫°t ƒë·ªông</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-info">
                        <h3>${inactiveSubscribers}</h3>
                        <p>ƒê√£ h·ªßy</p>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="search-filter">
                <form action="${pageContext.request.contextPath}/admin/newsletters" method="get" class="search-form">
                    <input type="text" name="search" placeholder="T√¨m ki·∫øm email..." value="${param.search}">
                    <select name="status">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="1" <c:if test="${param.status == '1'}">selected</c:if>>ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="0" <c:if test="${param.status == '0'}">selected</c:if>>ƒê√£ h·ªßy</option>
                    </select>
                    <button type="submit" class="btn-search">T√¨m ki·∫øm</button>
                </form>
            </div>
            
            <!-- Newsletter Table -->
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Email</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y ƒëƒÉng k√Ω</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        <c:forEach var="newsletter" items="${newsletters}">
                            <tr>
                                <td>
                                    <input type="checkbox" name="selectedEmails" value="${newsletter.email}" class="email-checkbox">
                                </td>
                                <td>${newsletter.email}</td>
                                <td>
                                    <c:choose>
                                        <c:when test="${newsletter.enabled == 1}">
                                            <span class="status-active">Ho·∫°t ƒë·ªông</span>
                                        </c:when>
                                        <c:otherwise>
                                            <span class="status-inactive">ƒê√£ h·ªßy</span>
                                        </c:otherwise>
                                    </c:choose>
                                </td>
                                <td>
                                    <c:choose>
                                        <c:when test="${not empty newsletter.createdDate}">
                                            <fmt:formatDate value="${newsletter.createdDate}" pattern="dd/MM/yyyy"/>
                                        </c:when>
                                        <c:otherwise>-</c:otherwise>
                                    </c:choose>
                                </td>
                                <td class="actions">
                                    <c:choose>
                                        <c:when test="${newsletter.enabled == 1}">
                                            <a href="${pageContext.request.contextPath}/admin/newsletters/disable?email=${newsletter.email}" 
                                               class="btn-warning" title="V√¥ hi·ªáu h√≥a" 
                                               onclick="return confirm('V√¥ hi·ªáu h√≥a email n√†y?')">üö´</a>
                                        </c:when>
                                        <c:otherwise>
                                            <a href="${pageContext.request.contextPath}/admin/newsletters/enable?email=${newsletter.email}" 
                                               class="btn-info" title="K√≠ch ho·∫°t" 
                                               onclick="return confirm('K√≠ch ho·∫°t l·∫°i email n√†y?')">‚úÖ</a>
                                        </c:otherwise>
                                    </c:choose>
                                    <a href="${pageContext.request.contextPath}/admin/newsletters/delete?email=${newsletter.email}" 
                                       class="btn-delete" title="X√≥a" 
                                       onclick="return confirm('X√≥a vƒ©nh vi·ªÖn email n√†y kh·ªèi danh s√°ch?')">üóëÔ∏è</a>
                                </td>
                            </tr>
                        </c:forEach>
                    </tbody>
                </table>
            </div>
            
            <c:if test="${empty newsletters}">
                <div class="empty-state">
                    <h3>Ch∆∞a c√≥ ƒëƒÉng k√Ω newsletter n√†o</h3>
                    <p>Danh s√°ch ƒëƒÉng k√Ω newsletter s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y khi c√≥ ng∆∞·ªùi ƒëƒÉng k√Ω.</p>
                </div>
            </c:if>
            
            <!-- Bulk Actions -->
            <c:if test="${not empty newsletters}">
                <div class="bulk-actions" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                    <span>V·ªõi email ƒë√£ ch·ªçn:</span>
                    <button type="button" class="btn-info" onclick="bulkEnable()">K√≠ch ho·∫°t</button>
                    <button type="button" class="btn-warning" onclick="bulkDisable()">V√¥ hi·ªáu h√≥a</button>
                    <button type="button" class="btn-delete" onclick="bulkDelete()">X√≥a</button>
                    <button type="button" class="btn-primary" onclick="sendToSelected()">G·ª≠i email</button>
                </div>
            </c:if>
            
            <!-- Pagination -->
            <c:if test="${totalPages > 1}">
                <div class="pagination">
                    <c:if test="${currentPage > 1}">
                        <a href="?page=${currentPage - 1}&search=${param.search}&status=${param.status}" 
                           class="prev">¬´ Tr∆∞·ªõc</a>
                    </c:if>
                    
                    <c:forEach begin="1" end="${totalPages}" var="i">
                        <c:choose>
                            <c:when test="${i == currentPage}">
                                <span class="current">${i}</span>
                            </c:when>
                            <c:otherwise>
                                <a href="?page=${i}&search=${param.search}&status=${param.status}">${i}</a>
                            </c:otherwise>
                        </c:choose>
                    </c:forEach>
                    
                    <c:if test="${currentPage < totalPages}">
                        <a href="?page=${currentPage + 1}&search=${param.search}&status=${param.status}" 
                           class="next">Sau ¬ª</a>
                    </c:if>
                </div>
            </c:if>
            
            <c:if test="${not empty message}">
                <div class="message ${messageType}">
                    ${message}
                </div>
            </c:if>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="admin-footer">
        <div class="container">
            <p>&copy; 2024 ABC News Admin Panel. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </footer>
    
    <script>
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.email-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function getSelectedEmails() {
            const checkboxes = document.querySelectorAll('.email-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function bulkEnable() {
            const emails = getSelectedEmails();
            if (emails.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt email!');
                return;
            }
            if (confirm(`K√≠ch ho·∫°t ${emails.length} email ƒë√£ ch·ªçn?`)) {
                // Implement bulk enable
                window.location.href = `${pageContext.request.contextPath}/admin/newsletters/bulk-enable?emails=${emails.join(',')}`;
            }
        }
        
        function bulkDisable() {
            const emails = getSelectedEmails();
            if (emails.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt email!');
                return;
            }
            if (confirm(`V√¥ hi·ªáu h√≥a ${emails.length} email ƒë√£ ch·ªçn?`)) {
                // Implement bulk disable
                window.location.href = `${pageContext.request.contextPath}/admin/newsletters/bulk-disable?emails=${emails.join(',')}`;
            }
        }
        
        function bulkDelete() {
            const emails = getSelectedEmails();
            if (emails.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt email!');
                return;
            }
            if (confirm(`X√≥a vƒ©nh vi·ªÖn ${emails.length} email ƒë√£ ch·ªçn?`)) {
                // Implement bulk delete
                window.location.href = `${pageContext.request.contextPath}/admin/newsletters/bulk-delete?emails=${emails.join(',')}`;
            }
        }
        
        function sendToSelected() {
            const emails = getSelectedEmails();
            if (emails.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt email!');
                return;
            }
            // Open send newsletter modal or redirect to send page
            window.open(`${pageContext.request.contextPath}/admin/newsletters/send?emails=${emails.join(',')}`, '_blank');
        }
        
        function exportEmails() {
            window.location.href = `${pageContext.request.contextPath}/admin/newsletters/export`;
        }
        
        function sendNewsletter() {
            window.open(`${pageContext.request.contextPath}/admin/newsletters/send`, '_blank');
        }
    </script>
</body>
</html>